# 🔧 버그 수정 및 신기능 안내

## 📅 업데이트 내역

### 🐛 수정된 버그

#### 1. 분할 매도 무한 반복 버그 수정
**문제:**
```
2026-02-08 04:07:14 [INFO] 🔴 매도 | KRW-ELSA | 수량: 0.00000000
2026-02-08 04:07:25 [INFO] 🔴 매도 | KRW-ELSA | 수량: 0.00000000
2026-02-08 04:07:36 [INFO] 🔴 매도 | KRW-ELSA | 수량: 0.00000000
```
- 1차 익절 후에도 계속 1차 익절 조건으로 매도 시도
- 수량이 0인데도 매도 주문 발생

**해결:**
- ✅ 이미 매도한 비율을 추적하여 중복 매도 방지
- ✅ 최소 주문 금액(5,000원) 체크 추가
- ✅ 분할 매도 조건 개선

**수정된 로직:**
```python
# 1차 익절: 아직 매도 안 했을 때만 (sold_ratio < 10%)
if profit_rate >= 1.5% and sold_ratio < 0.1:
    50% 매도
    
# 2차 익절: 1차는 했고 2차는 안 했을 때만 (40% ≤ sold_ratio < 70%)
if profit_rate >= 3.0% and 0.4 ≤ sold_ratio < 0.7:
    30% 추가 매도
```

---

### ✨ 신규 기능

#### 1. 자동 코인 목록 갱신 🔄

**기능:**
- 설정한 시간마다 자동으로 거래 적합 코인 재선정
- 목록에서 제외된 코인은 자동 청산

**설정:**
```json
{
  "coin_selection": {
    "refresh_interval_hours": 1  // 1시간마다 갱신
  }
}
```

**동작 예시:**
```
[10:00] 코인 선정: BTC, ETH, SOL
[11:00] 코인 갱신: BTC, XRP, DOGE
        → SOL 포지션 청산
        → XRP, DOGE 신규 모니터링 시작
```

---

#### 2. 제외 코인 설정 🚫

**기능:**
- 특정 코인을 거래 목록에서 영구 제외
- 변동성이 너무 크거나 선호하지 않는 코인 제외

**설정:**
```json
{
  "coin_selection": {
    "excluded_coins": ["BTC", "ETH", "SHIB"]
  }
}
```

**사용 예시:**

1. **메이저 코인 제외 (중소형 코인만 거래)**
```json
{
  "excluded_coins": ["BTC", "ETH"]
}
```

2. **밈코인 제외 (변동성 과다)**
```json
{
  "excluded_coins": ["SHIB", "DOGE", "PEPE"]
}
```

3. **특정 섹터 제외**
```json
{
  "excluded_coins": ["BTC", "BCH", "BSV"]  // 비트코인 계열 제외
}
```

---

## 📊 개선된 분할 매도 시나리오

### 시나리오 1: 정상적인 분할 매도
```
[매수]
코인: KRW-SOL
가격: 100,000원
수량: 1.0 SOL
금액: 100,000원

[1차 익절] 가격 101,500원 (+1.5%)
- 매도 수량: 0.5 SOL (50%)
- 수익: +750원
- 남은 수량: 0.5 SOL
- sold_ratio: 50%

[2차 익절] 가격 103,000원 (+3.0%)
- 매도 수량: 0.3 SOL (원래 수량의 30%)
- 수익: +900원
- 남은 수량: 0.2 SOL
- sold_ratio: 80%

[최종 청산] 가격 102,000원
- 트레일링 스탑 발동
- 남은 0.2 SOL 전량 매도
- 총 수익: +2,050원 (+2.05%)
```

### 시나리오 2: 소액 자동 청산
```
[매수]
코인: KRW-XRP
가격: 1,000원
수량: 100 XRP
금액: 100,000원

[1차 익절] 가격 1,015원 (+1.5%)
- 매도 수량: 50 XRP
- 남은 수량: 50 XRP
- 남은 금액: 50,750원

[계속 상승] 가격 1,020원
- 남은 금액: 51,000원
- BUT 1차 익절 조건은 다시 발동 안 함 (이미 매도했음)

[소액 자동 청산]
- 남은 50 XRP × 1,020원 = 51,000원
- 5,000원 이상이므로 정상 거래 가능
- (만약 4,900원이라면 자동 전량 청산)
```

---

## ⚙️ 권장 설정

### 보수적 설정 (안정성 중시)
```json
{
  "coin_selection": {
    "refresh_interval_hours": 2,
    "excluded_coins": ["SHIB", "PEPE", "FLOKI"]
  },
  "risk_management": {
    "stop_loss_pct": -1.0,
    "take_profit_1_pct": 1.0,
    "take_profit_2_pct": 2.0
  }
}
```

### 균형 설정 (기본)
```json
{
  "coin_selection": {
    "refresh_interval_hours": 1,
    "excluded_coins": []
  },
  "risk_management": {
    "stop_loss_pct": -1.5,
    "take_profit_1_pct": 1.5,
    "take_profit_2_pct": 3.0
  }
}
```

### 공격적 설정 (수익성 중시)
```json
{
  "coin_selection": {
    "refresh_interval_hours": 0.5,
    "excluded_coins": ["BTC", "ETH"]
  },
  "risk_management": {
    "stop_loss_pct": -2.0,
    "take_profit_1_pct": 2.0,
    "take_profit_2_pct": 4.0
  }
}
```

---

## 🔍 로그 확인 방법

### 정상 동작 확인
```
[좋은 예]
2026-02-08 10:00:15 [INFO] 🔴 매도 | KRW-SOL | 수량: 0.50000000 | 1차익절(1.52%)
2026-02-08 10:15:22 [INFO] 🔴 매도 | KRW-SOL | 수량: 0.30000000 | 2차익절(3.11%)
```

### 비정상 동작
```
[나쁜 예 - 이제 수정됨]
2026-02-08 10:00:15 [INFO] 🔴 매도 | KRW-SOL | 수량: 0.00000000 | 1차익절(1.52%)
2026-02-08 10:00:26 [INFO] 🔴 매도 | KRW-SOL | 수량: 0.00000000 | 1차익절(1.52%)
```

---

## 🎯 코인 갱신 동작 확인

### 로그 예시
```
2026-02-08 10:00:00 [INFO] 🔄 코인 목록 갱신 시작
2026-02-08 10:00:05 [INFO] 🔍 거래 적합 코인 분석 시작...
2026-02-08 10:00:10 [INFO] 🏆 선정된 거래 코인
                           (제외 코인: BTC, ETH)
                           [1] SOL | 거래량: 450억 | 변동성: 5.2%
                           [2] XRP | 거래량: 380억 | 변동성: 4.8%
                           [3] DOGE | 거래량: 320억 | 변동성: 6.1%
2026-02-08 10:00:11 [INFO] 📤 목록에서 제외된 코인 정리: ADA
2026-02-08 10:00:12 [INFO] 🔴 매도 | KRW-ADA | 수익률: +0.8% | 목록갱신 정리
2026-02-08 10:00:13 [INFO] ✅ 코인 목록 갱신 완료: SOL, XRP, DOGE
```

---

## 💡 활용 팁

### 1. 시간대별 갱신 전략
```json
// 변동성 높은 시간대: 짧은 주기
{
  "refresh_interval_hours": 0.5  // 30분마다
}

// 안정적인 시간대: 긴 주기
{
  "refresh_interval_hours": 2  // 2시간마다
}
```

### 2. 섹터별 전략
```json
// DeFi 코인만
{
  "excluded_coins": ["BTC", "ETH", "XRP", "DOGE", "SHIB"]
}

// 메이저 + 중형만
{
  "excluded_coins": ["SHIB", "PEPE", "FLOKI", "BONK"]
}
```

### 3. 변동성별 전략
```json
// 안정적인 코인만
{
  "max_volatility": 8,
  "excluded_coins": ["SHIB", "PEPE"]
}

// 변동성 높은 코인만
{
  "min_volatility": 6,
  "max_volatility": 20
}
```

---

## 📞 문제 해결

### Q1. 코인 목록이 갱신되지 않습니다
**A:** 
- `refresh_interval_hours` 설정 확인
- 로그에서 "코인 목록 갱신" 메시지 확인
- 최소 설정값: 0.5 (30분)

### Q2. 제외 코인이 여전히 선정됩니다
**A:**
- 코인 심볼 확인 (BTC, ETH, 대문자)
- KRW- 접두사는 붙이지 않음
- 프로그램 재시작 필요

### Q3. 분할 매도가 작동하지 않습니다
**A:**
- 로그에서 "sold_ratio" 확인
- 최소 주문 금액 5,000원 이상인지 확인
- 포지션 정보 초기화 (stop 후 start)

---

## ✅ 체크리스트

업데이트 후 확인사항:

- [ ] config.json에 `refresh_interval_hours` 추가
- [ ] config.json에 `excluded_coins` 추가 (필요 시)
- [ ] 프로그램 재시작
- [ ] 로그에서 "코인 목록 갱신" 메시지 확인
- [ ] 1시간 후 자동 갱신 동작 확인
- [ ] 분할 매도 로그에서 수량 확인 (0이 아닌지)

---

이제 더 안정적이고 스마트한 매매가 가능합니다! 🎉
