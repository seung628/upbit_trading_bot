# 🚀 신규 기능 안내 - 지정가 주문 & ATR 기반 손익


## 📋 업데이트 내역

### ✨ 주요 신규 기능

1. **지정가 주문 우선 + 시장가 폴백** 💰
2. **ATR 기반 손절/익절** 📊  
3. **향상된 커맨드 인터페이스** 🖥️
4. **일일 통계 명령어** 📅

---

## 1️⃣ 지정가 주문 시스템

### 💡 개념

**기존 (시장가 주문):**
```
매수/매도 즉시 체결
→ 슬리피지 발생 (가격 미끄러짐)
→ 수수료 0.05%
```

**신규 (지정가 우선):**
```
1단계: 지정가 주문 (최선 호가)
2단계: 3초 대기
3단계: 체결 확인
   - 체결 완료 → 수수료 0.025% (절반)
   - 미체결 → 취소 후 시장가로 전환
```

### 📊 예상 효과

**수수료 절감:**
```
거래 1회당:
시장가: 100,000원 × 0.05% = 50원
지정가: 100,000원 × 0.025% = 25원
절감: 50% (25원)

하루 10회 거래 시:
시장가: 500원
지정가: 250원
월간 절감: 약 7,500원
```

**슬리피지 방지:**
```
시장가 매수:
목표가: 100,000원
실제 체결: 100,050원 (50원 손실)

지정가 매수:
목표가: 100,000원  
실제 체결: 99,950원 (50원 이득)

평균 100원 차이!
```

### ⚙️ 설정

```json
{
  "trading": {
    "order_type": "limit_with_fallback",  // 지정가 우선
    "limit_order_wait_seconds": 3         // 대기 시간
  }
}
```

**옵션:**
- `"limit_with_fallback"` - 지정가 우선 (기본 추천)
- `"market"` - 시장가만 사용 (빠른 체결)

---

## 2️⃣ ATR 기반 손절/익절

### 💡 개념

**ATR (Average True Range):**
- 최근 14개 봉의 평균 변동폭
- 변동성을 수치화한 지표
- 코인마다 다른 값

**기존 (고정 %):**
```
모든 코인:
손절 -1.5%
익절 +1.5%

문제: BTC와 SHIB의 변동성이 다름
```

**신규 (ATR 기반):**
```
BTC (변동성 낮음):
ATR = 50,000원
손절 = 매수가 - (50,000 × 1.5) = -75,000원
익절 = 매수가 + (50,000 × 2.5) = +125,000원

SHIB (변동성 높음):
ATR = 5원
손절 = 매수가 - (5 × 1.5) = -7.5원
익절 = 매수가 + (5 × 2.5) = +12.5원

→ 각 코인의 특성 반영!
```

### 📊 장점

✅ **불필요한 손절 감소**
```
고정 -1.5% 방식:
조용한 시간 → 정상 변동도 손절
변동성 장 → 손절 후 바로 반등

ATR 방식:
조용한 시간 → 타이트한 손절
변동성 장 → 여유로운 손절
```

✅ **코인별 최적화**
```
메이저 코인 (BTC, ETH):
→ 넓은 손절/익절폭

밈코인 (SHIB, PEPE):
→ 변동성 감안한 손절/익절
```

### ⚙️ 설정

```json
{
  "risk_management": {
    "use_atr": true,                    // ATR 사용 (기본 true)
    "atr_period": 14,                   // ATR 계산 기간
    "atr_stop_loss_multiplier": 1.5,    // 손절 = ATR × 1.5
    "atr_take_profit_multiplier": 2.5,  // 익절 = ATR × 2.5
    
    "stop_loss_pct": -1.5,              // ATR 폴백용 고정 %
    "take_profit_1_pct": 1.5            // 분할 익절은 고정 % 유지
  }
}
```

**ATR 배수 조정:**
```
보수적 (안정):
stop_loss_multiplier: 2.0
take_profit_multiplier: 3.0

공격적 (수익):
stop_loss_multiplier: 1.0
take_profit_multiplier: 2.0
```

### 🔄 동작 방식

```python
# 손절 우선순위
1. ATR 기반 손절 (use_atr = true 일 때)
   → 현재가 ≤ 매수가 - (ATR × 1.5)
   
2. 고정 % 손절 (폴백)
   → 수익률 ≤ -1.5%

# 익절 우선순위  
1. ATR 기반 익절 (use_atr = true 일 때)
   → 현재가 ≥ 매수가 + (ATR × 2.5)
   
2. 분할 익절 (고정 % 유지)
   → +1.5% 1차, +3.0% 2차
```

---

## 3️⃣ 향상된 커맨드 인터페이스

### 🎯 명령어 히스토리

**기능:**
- ⬆️ 위 방향키: 이전 명령어
- ⬇️ 아래 방향키: 다음 명령어
- 최근 100개 명령어 기록

**사용 예:**
```
💻 명령어 입력 > status
(상태 확인...)

💻 명령어 입력 > ⬆️  (위 방향키)
💻 명령어 입력 > status  (자동 입력됨)
```

### 📅 일일 통계 명령어

**신규 명령어: `daily`**

```
💻 명령어 입력 > daily

📅 일일 거래 통계
=====================================
📊 오늘 (2026-02-08)
  총 거래: 15회
  승/패: 9승 6패
  승률: 60.0%

💰 수익 현황
  총 손익: +12,500원
  평균 손익: +833원

🏆 최고 거래
  코인: SOL
  수익률: +3.45%
  손익: +3,450원
  사유: 2차익절

📉 최악 거래
  코인: XRP
  수익률: -1.52%
  손익: -1,520원
  사유: 손절

📌 코인별 성과
  📈 SOL: 5회 | +5,200원
  📈 BTC: 4회 | +3,100원
  📈 DOGE: 3회 | +2,800원
  📉 XRP: 3회 | -1,600원
```

---

## 4️⃣ 전체 명령어 목록

```
start   - 트레이딩 시작
stop    - 트레이딩 정지 및 청산
status  - 현재 상태 및 포지션
daily   - 오늘의 거래 통계 (신규)
help    - 도움말
exit    - 프로그램 종료
```

---

## 📈 실제 사용 예시

### 시나리오 1: 안정적인 BTC 거래

**설정:**
```json
{
  "risk_management": {
    "use_atr": true,
    "atr_stop_loss_multiplier": 1.5,
    "atr_take_profit_multiplier": 2.5
  }
}
```

**매수:**
```
BTC 매수가: 60,000,000원
현재 ATR: 500,000원

지정가 주문:
→ 매수 1호가: 59,950,000원
→ 3초 대기
→ 체결 완료! (50,000원 절감)

ATR 기반 손절/익절:
손절가: 59,250,000원 (500,000 × 1.5 = 750,000원 아래)
익절가: 61,250,000원 (500,000 × 2.5 = 1,250,000원 위)
```

### 시나리오 2: 변동성 높은 DOGE

**설정:**
```json
{
  "risk_management": {
    "use_atr": true,
    "atr_stop_loss_multiplier": 2.0,  // 여유롭게
    "atr_take_profit_multiplier": 3.0
  }
}
```

**매수:**
```
DOGE 매수가: 200원
현재 ATR: 10원

ATR 기반 손절/익절:
손절가: 180원 (10 × 2.0 = 20원 아래)
익절가: 230원 (10 × 3.0 = 30원 위)

고정 % 방식이었다면:
손절: 197원 (-1.5%) → 너무 타이트
익절: 203원 (+1.5%) → 너무 짧음

ATR 방식으로 변동성 감안!
```

---

## ⚙️ 권장 설정

### 초보자 (안정)
```json
{
  "trading": {
    "order_type": "limit_with_fallback",
    "limit_order_wait_seconds": 3
  },
  "risk_management": {
    "use_atr": true,
    "atr_stop_loss_multiplier": 2.0,
    "atr_take_profit_multiplier": 3.0
  }
}
```

### 중급자 (균형)
```json
{
  "trading": {
    "order_type": "limit_with_fallback",
    "limit_order_wait_seconds": 3
  },
  "risk_management": {
    "use_atr": true,
    "atr_stop_loss_multiplier": 1.5,
    "atr_take_profit_multiplier": 2.5
  }
}
```

### 고급자 (공격)
```json
{
  "trading": {
    "order_type": "limit_with_fallback",
    "limit_order_wait_seconds": 2
  },
  "risk_management": {
    "use_atr": true,
    "atr_stop_loss_multiplier": 1.0,
    "atr_take_profit_multiplier": 2.0
  }
}
```

---

## 💡 사용 팁

### 1. ATR 확인하기
로그에서 ATR 값 확인:
```
[INFO] 🔴 매도 | KRW-BTC | ATR손절(-1.23%)
→ ATR 기준 손절 작동 확인
```

### 2. 수수료 절감 확인
로그에서 지정가 체결 확인:
```
[INFO] ✅ 지정가 체결: 59,950,000원
→ 지정가로 체결된 경우
```

### 3. 일일 통계 활용
```
매일 거래 종료 전:
💻 명령어 입력 > daily

→ 오늘의 성과 확인
→ 어떤 코인이 잘 맞는지 파악
→ 전략 조정
```

---

## 🔧 문제 해결

### Q1. 지정가 주문이 너무 자주 미체결됩니다
**A:** 대기 시간 늘리기
```json
{
  "limit_order_wait_seconds": 5  // 3초 → 5초
}
```

### Q2. ATR 손절이 너무 넓습니다
**A:** 배수 줄이기
```json
{
  "atr_stop_loss_multiplier": 1.0  // 1.5 → 1.0
}
```

### Q3. 명령어 히스토리가 작동하지 않습니다
**A:** Windows에서는 일부 터미널에서 지원 안 됨
- CMD 대신 PowerShell 사용
- 또는 Git Bash 사용

---

## 📊 예상 성과

### 수수료 절감
```
월 거래 300회 기준:
기존: 300회 × 50원 = 15,000원
신규: 300회 × 25원 = 7,500원

연간 절감: 90,000원
```

### ATR 효과
```
불필요한 손절 20% 감소:
기존: 손절 20회 → 손실 -300,000원
신규: 손절 16회 → 손실 -240,000원

연간 이득: 600,000원
```

**총 예상 이득: 약 69만원/년**

---

이제 더욱 효율적이고 스마트한 매매가 가능합니다! 🎉
