# 📝 업데이트 내역 - 매수/매도 로직 개선

## 🔄 주요 변경사항

### 1. 고정 매수 금액 설정 ✅

**변경 전:**
- 잔고의 일정 비율(예: 30%)로 매수
- `invest_ratio_per_coin: 0.3` 설정 사용

**변경 후:**
- 고정 금액으로 매수
- `buy_amount_krw: 100000` 설정 사용 (10만원)

**장점:**
- ✅ 더 명확한 리스크 관리
- ✅ 자금 관리가 간단함
- ✅ 예상 가능한 손익 계산

**설정 예시:**
```json
{
  "trading": {
    "buy_amount_krw": 100000  // 1회 매수 시 10만원씩 투자
  }
}
```

### 2. 매수 수량 기준 매도 ✅

**변경 전:**
- 실제 지갑 잔고를 기준으로 매도
- 다른 곳에서 입금한 코인까지 매도 가능

**변경 후:**
- 프로그램이 매수한 수량만 정확히 매도
- 포지션 관리 시스템으로 추적

**장점:**
- ✅ 정확한 수익률 계산
- ✅ 다른 보유 코인과 섞이지 않음
- ✅ 분할 매도 시 정확한 수량 관리

**동작 방식:**
1. 매수 시: 수량을 포지션에 기록
   ```python
   position = {
       'buy_price': 60000000,
       'amount': 0.00166666,      # 매수한 수량
       'original_amount': 0.00166666  # 원래 매수 수량
   }
   ```

2. 매도 시: 기록된 수량만 매도
   ```python
   # 50% 분할 매도
   sell_amount = position['amount'] * 0.5
   # = 0.00083333 (정확히 매수한 수량의 절반만)
   ```

## 📊 실제 거래 예시

### 예시 1: 전량 매도
```
[매수]
- 코인: BTC
- 매수가: 60,000,000원
- 매수 금액: 100,000원
- 매수 수량: 0.00166666 BTC

[매도]
- 매도가: 61,500,000원 (+2.5%)
- 매도 수량: 0.00166666 BTC (매수한 수량 전부)
- 수익: 약 2,500원
```

### 예시 2: 분할 매도
```
[매수]
- 코인: ETH
- 매수가: 3,000,000원
- 매수 금액: 100,000원
- 매수 수량: 0.03333333 ETH

[1차 익절] (+1.5% 도달)
- 매도 수량: 0.01666666 ETH (50%)
- 남은 수량: 0.01666667 ETH

[2차 익절] (+3% 도달)
- 매도 수량: 0.00500000 ETH (원래 수량의 30%)
- 남은 수량: 0.01166667 ETH

[최종 매도]
- 매도 수량: 0.01166667 ETH (나머지 전부)
```

## ⚙️ 설정 가이드

### 초보자 (안정 중시)
```json
{
  "trading": {
    "buy_amount_krw": 50000  // 5만원씩 투자
  },
  "risk_management": {
    "stop_loss_pct": -1.0    // 손절 -1%
  }
}
```

### 일반 (균형)
```json
{
  "trading": {
    "buy_amount_krw": 100000  // 10만원씩 투자
  },
  "risk_management": {
    "stop_loss_pct": -1.5     // 손절 -1.5%
  }
}
```

### 공격적 (수익 중시)
```json
{
  "trading": {
    "buy_amount_krw": 200000  // 20만원씩 투자
  },
  "risk_management": {
    "stop_loss_pct": -2.0     // 손절 -2%
  }
}
```

## 🎯 권장 설정

### 초기 자금별 권장 매수 금액

| 초기 자금 | 권장 1회 매수액 | 최대 동시 거래 | 설명 |
|----------|---------------|--------------|------|
| 30만원 | 50,000원 | 3개 코인 | 안전하게 시작 |
| 50만원 | 100,000원 | 3개 코인 | 기본 설정 |
| 100만원 | 200,000원 | 3개 코인 | 표준 설정 |
| 500만원 | 500,000원 | 3개 코인 | 적극적 운용 |

**계산 공식:**
```
1회 매수액 = 초기 자금 / (최대 동시 거래 수 * 1.5 ~ 2)
```

예: 100만원 / (3개 * 2) = 약 166,000원
→ 여유를 고려하여 100,000원 설정

## 🔍 변경된 파일 목록

1. **config.json** - `buy_amount_krw` 설정 추가
2. **config.example.json** - 설정 예시 업데이트
3. **trading_stats.py** - 매수 수량 추적 개선
4. **trading_engine.py** - 매도 로직 수정
5. **main.py** - 매수/매도 로직 통합 수정
6. **README.md** - 문서 업데이트

## ⚠️ 주의사항

1. **매수 금액 설정 시:**
   - 최소 5,500원 이상 (업비트 최소 주문금액)
   - 잔고보다 큰 금액 설정 시 매수 실패
   - 동시 거래 코인 수를 고려하여 설정

2. **기존 실행 중인 봇:**
   - 기존 포지션은 자동으로 새 시스템에 적용됨
   - 설정 변경 후 재시작 권장

3. **잔고 관리:**
   ```
   필요 최소 잔고 = buy_amount_krw * max_coins + 여유금
   
   예: 10만원 * 3개 = 30만원 + 여유금 5만원 = 35만원
   ```

## 💡 테스트 방법

1. **소액으로 테스트:**
   ```json
   {
     "trading": {
       "buy_amount_krw": 10000  // 1만원씩 테스트
     }
   }
   ```

2. **로그 확인:**
   - `logs/trades.log` 파일에서 매수/매도 수량 확인
   - 수익률이 정확히 계산되는지 확인

3. **분할 매도 확인:**
   - 1차 익절 후 수량이 정확히 50% 줄어드는지 확인
   - 2차 익절 후 나머지 수량 확인

## 📞 문제 해결

### Q1. 매수가 안 됩니다
**A:** 잔고가 `buy_amount_krw`보다 적은지 확인
```
현재 잔고 >= buy_amount_krw 여야 매수 가능
```

### Q2. 수익률이 이상합니다
**A:** 기존 보유 코인이 있는 경우, 프로그램 재시작으로 포지션 초기화

### Q3. 분할 매도가 작동하지 않습니다
**A:** 로그 확인 후 포지션 정보가 정확한지 확인

## 🎉 업데이트 완료!

이제 더 정확하고 예측 가능한 매매가 가능합니다!
