# 🚨 긴급 버그 수정 (v1.0.4.1)

## 날짜: 2026-02-10
## 심각도: 높음 ⚠️

---

## 🐛 발견된 심각한 버그

### 증상
```
[DEBUG] KRW-BTC 이미 매수 진행 중 - 건너뜀
[DEBUG] KRW-BTC 이미 매수 진행 중 - 건너뜀
[DEBUG] KRW-BTC 이미 매수 진행 중 - 건너뜀
...
(계속 반복, 실제 매수는 안 됨)
```

**실제 매수를 하지 않았는데도 "매수 진행 중" 상태가 되어 영구적으로 매수가 불가능해지는 문제**

---

## 🔍 원인 분석

### 문제가 있던 코드 (v1.0.4)

```python
# Line 978: buying_in_progress에 추가
self.buying_in_progress.add(ticker)

# Line 980: 매수 신호 확인
buy_signal, signals, current_price, signal_score = self.engine.check_buy_signal(ticker)

if buy_signal and current_price:
    # 호가창 안전성 체크
    is_safe, safety_msg = self.engine.check_orderbook_safety(ticker)
    if not is_safe:
        continue  # ❌ 여기서 continue하면?
    
    # 투자 금액 계산
    invest_amount = self._calculate_dynamic_investment(signal_score)
    if invest_amount < min_amount:
        continue  # ❌ 여기서 continue하면?
    
    # 잔고 확인
    if available_krw < invest_amount:
        continue  # ❌ 여기서 continue하면?
    
    try:
        # 매수 실행
        ...
    finally:
        # ✅ 여기서만 제거
        self.buying_in_progress.discard(ticker)
```

**문제:**
- `buying_in_progress.add()` 실행 후
- `buy_signal`이 False거나
- 호가 불안정하거나
- 투자 한도 초과하거나
- 잔고 부족하면
- `continue`로 빠져나감
- **`finally` 블록에 도달하지 못함**
- **`buying_in_progress`에서 제거 안 됨** 💥
- **영구적으로 "매수 진행 중" 상태** 💥

---

## ✅ 해결 방법

### 수정된 코드 (v1.0.4.1)

```python
# 1단계: 기본 체크 (buying_in_progress 추가 안 함)
with self.buy_lock:
    if ticker in self.buying_in_progress:
        continue
    if ticker in self.stats.positions:
        continue
    # 실제 잔고 체크...

# 2단계: 매수 신호 확인
buy_signal, signals, current_price, signal_score = self.engine.check_buy_signal(ticker)

if buy_signal and current_price:
    # 호가 체크
    if not is_safe:
        continue  # ✅ 이제 안전하게 continue 가능
    
    # 투자 금액 체크
    if invest_amount < min_amount:
        continue  # ✅ 안전
    
    # 잔고 체크
    if available_krw >= invest_amount:
        # ✅ 여기서 buying_in_progress 추가 (실제 매수 직전)
        with self.buy_lock:
            # 최종 재확인
            if ticker in self.buying_in_progress or ticker in self.stats.positions:
                continue
            
            self.buying_in_progress.add(ticker)
        
        try:
            # 매수 실행
            ...
        finally:
            # 제거
            self.buying_in_progress.discard(ticker)
```

**개선점:**
1. ✅ `buying_in_progress.add()`를 `try` 블록 직전으로 이동
2. ✅ 모든 사전 체크 통과 후에만 추가
3. ✅ 추가 즉시 `try-finally`로 진입
4. ✅ 어떤 경우에도 `finally`에서 제거 보장

---

## 📊 Before / After 비교

### Before (v1.0.4) - 버그 있음

```
Time 00:00 - BTC 체크
  ✅ buying_in_progress 비어있음
  ✅ self.buying_in_progress.add('KRW-BTC')  ← 추가
  ✅ check_buy_signal() 실행
  ❌ buy_signal = False (신호 없음)
  ❌ if buy_signal: 블록 진입 안 함
  ❌ finally 블록 도달 안 함
  ❌ buying_in_progress에서 제거 안 됨!

Time 00:10 - BTC 체크
  ❌ 'KRW-BTC' in buying_in_progress
  ❌ "이미 매수 진행 중 - 건너뜀"
  
Time 00:20 - BTC 체크
  ❌ "이미 매수 진행 중 - 건너뜀"
  
... 영원히 반복 ...
```

### After (v1.0.4.1) - 수정됨

```
Time 00:00 - BTC 체크
  ✅ buying_in_progress 비어있음
  ✅ check_buy_signal() 실행
  ❌ buy_signal = False (신호 없음)
  ❌ if buy_signal: 블록 진입 안 함
  ✅ buying_in_progress.add() 실행 안 함
  ✅ 깔끔하게 종료

Time 00:10 - BTC 체크
  ✅ buying_in_progress 비어있음
  ✅ 정상적으로 다시 체크
  
Time 00:20 - BTC 신호 발생!
  ✅ 모든 체크 통과
  ✅ buying_in_progress.add('KRW-BTC')
  ✅ try 블록 진입
  ✅ 매수 실행
  ✅ finally에서 제거
  ✅ 정상 완료
```

---

## 🚀 적용 방법

### 방법 1: 전체 파일 교체 (권장)
```bash
# 새로운 main.py 다운로드 후
cp main.py /your/trading/bot/directory/
```

### 방법 2: 수동 수정
main.py 파일의 Line 953~1050 부분을 아래 코드로 교체:

```python
                    # 포지션 없을 때 - 매수 검토
                    if ticker not in self.stats.positions:
                        
                        # 중복 매수 방지 1차 체크
                        with self.buy_lock:
                            # 1단계: 매수 진행 중 체크
                            if ticker in self.buying_in_progress:
                                self.logger.debug(f"  {ticker} 이미 매수 진행 중 - 건너뜀")
                                continue
                            
                            # 2단계: 포지션 재확인 (Race Condition 방지)
                            if ticker in self.stats.positions:
                                self.logger.debug(f"  {ticker} 이미 포지션 보유 중 - 건너뜀")
                                continue
                            
                            # 3단계: 실제 잔고 확인 (유령 포지션 방지)
                            coin = ticker.split('-')[1]
                            actual_balance = self.engine.upbit.get_balance(coin)
                            if actual_balance > 0:
                                self.logger.warning(
                                    f"  ⚠️  {ticker} 실제 잔고 존재 ({actual_balance:.8f}), 매수 취소"
                                )
                                continue
                        
                        # 매수 신호 확인
                        buy_signal, signals, current_price, signal_score = self.engine.check_buy_signal(ticker)
                        
                        if buy_signal and current_price:
                            # 호가창 안전성 체크
                            is_safe, safety_msg = self.engine.check_orderbook_safety(ticker)
                            if not is_safe:
                                self.logger.debug(f"  {ticker} 호가 불안정: {safety_msg}")
                                continue
                            
                            # 동적 투자 금액 계산
                            invest_amount = self._calculate_dynamic_investment(signal_score)
                            
                            if invest_amount >= self.config['trading']['min_trade_amount']:
                                # 잔고 확인
                                available_krw = self.engine.get_balance("KRW")
                                
                                if available_krw >= invest_amount:
                                    # 매수 진행 표시 (실제 매수 직전)
                                    with self.buy_lock:
                                        # 최종 재확인 (다른 스레드에서 이미 매수했을 수 있음)
                                        if ticker in self.buying_in_progress or ticker in self.stats.positions:
                                            self.logger.debug(f"  {ticker} 최종 체크 실패 - 건너뜀")
                                            continue
                                        
                                        self.buying_in_progress.add(ticker)
                                    
                                    try:
                                        # 매수 실행
                                        buy_result = self.engine.execute_buy(ticker, invest_amount)
                                        
                                        # ... 나머지 코드 동일 ...
                                    
                                    finally:
                                        # 매수 완료 (성공/실패 상관없이 제거)
                                        with self.buy_lock:
                                            self.buying_in_progress.discard(ticker)
                            else:
                                self.logger.debug(f"  {ticker} 투자 한도 초과 또는 부족")
```

---

## 🧪 테스트

### 정상 작동 확인

```bash
# 프로그램 실행
python main.py
> start

# 로그 확인
tail -f logs/trading_bot.log
```

**정상 로그 예시:**
```
[DEBUG] KRW-BTC 매수 신호 체크 중...
[DEBUG] KRW-BTC 호가 불안정: 스프레드 0.8%
# 이후 계속 정상적으로 체크됨

또는

[INFO] 🔵 매수 완료 | KRW-BTC | 100,000원
# 정상 매수 완료
```

**버그 로그 (수정 전):**
```
[DEBUG] KRW-BTC 이미 매수 진행 중 - 건너뜀
[DEBUG] KRW-BTC 이미 매수 진행 중 - 건너뜀
[DEBUG] KRW-BTC 이미 매수 진행 중 - 건너뜀
# 계속 반복... ← 이게 보이면 버그!
```

---

## 🆘 긴급 복구 방법

### 현재 "매수 진행 중" 상태에 갇혀있다면?

```bash
# 프로그램 재시작
python main.py
> stop
> exit

# 다시 시작
python main.py
> start
```

**이유:**
- `buying_in_progress`는 메모리에만 존재 (파일에 저장 안 됨)
- 프로그램 재시작하면 자동으로 초기화됨
- 스냅샷 파일(`positions_snapshot.json`)은 영향 없음

---

## 📈 영향 범위

### 영향받는 경우
- ✅ v1.0.4 사용 중
- ✅ 매수 신호가 자주 발생했다 사라지는 경우
- ✅ 호가 불안정한 코인 거래 시
- ✅ 투자 한도에 자주 걸리는 경우

### 영향 없는 경우
- ✅ v1.0.3 이하 사용 중 (이 버그 없음)
- ✅ v1.0.4.1로 업데이트 완료
- ✅ 매도 로직 (전혀 영향 없음)

---

## ✨ 최종 확인

### 버전 확인
```python
# main.py 파일에서 확인
# Line 1000 근처를 보면:

# v1.0.4 (버그 있음):
# buying_in_progress.add(ticker)가 Line 978 근처
# check_buy_signal() 호출보다 먼저

# v1.0.4.1 (수정됨):
# buying_in_progress.add(ticker)가 Line 1000 근처
# try 블록 바로 앞, 모든 체크 통과 후
```

---

## 🎉 결론

**이 버그는 매우 치명적이었습니다!**

- 매수 신호가 있어도 "진행 중"으로 표시되어 영구 차단
- 프로그램 재시작 전까지 해당 코인 매수 불가
- 수익 기회 손실

**v1.0.4.1로 업데이트하면 완전히 해결됩니다!** ✅

---

**Version:** 1.0.4.1  
**Date:** 2026-02-10  
**Priority:** 🚨 CRITICAL - 즉시 업데이트 권장
